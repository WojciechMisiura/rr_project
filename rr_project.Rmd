---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

## Context
As part of Reproducible Research course which is Mandatory course for 2nd year students of Data Science and Business Analytics, we are reproducing already existing project. 

Link to the project:
https://www.kaggle.com/code/alfiansyahachmad/walmart-sales-analysis-eda-and-econometrics

## Description
Walmart is an American multinational retail corporation that operates a chain of hypermarkets, discount department stores, and grocery stores from the United States, headquartered in Bentonville, Arkansas (Wikipedia).

In Retail Industry, sales is the most important metric in their business model that make profit. On this reason, sales analysis will be a good way in determining business operation.

In this below dataset We'll reproduce the wxisting analysis how Walmart Sales looks like (Trend and Seasonal) and explain wether available feature (macroeconomic condition) would be affecting it using Econometric Panel Regression (Fixed Effect and Random Effect).

##All required libraries will be listed here

```{r}
library(readr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(zoo)
library(scales)
```

##All required packages will be listed here

```{r}
install.packages("zoo")
install.packages("scales")

```


##First we read the dataset

```{r}
url<-"https://raw.githubusercontent.com/WojciechMisiura/rr_project/main/Walmart_Store_sales.csv" #as we already added our dataset to github, we will read data directly from github

data<-read_csv(url)

head(data)
spec(data)
```

```{r}
names(data)
```

```{r}
colnames(data)
```

```{r}
str(data)
```

```{r}
summary(data)
```

```{r}
colSums(is.na(data))
```

```{r}
any(duplicated(data))
```

```{r}
data$Date <- as.Date(data$Date, format = "%d-%m-%Y")

data$Weekly_Sales <- round(data$Weekly_Sales / 1000, 3)
data$CPI <- round(data$CPI, 2)

data2 <- data

data2 <- data2[order(data2$Date), ]

panel <- data2 %>%
  group_by(Store, Date) %>%
  summarise(
    Weekly_Sales = mean(Weekly_Sales),
    Holiday_Flag = mean(Holiday_Flag),
    Temperature = mean(Temperature),
    Fuel_Price = mean(Fuel_Price),
    CPI = mean(CPI),
    Unemployment = mean(Unemployment),
    .groups = "drop"
  )

panel$Month <- month(panel$Date)
panel$Year <- year(panel$Date)

head(panel)
```

```{r}
data_sub <- data[, !(names(data) %in% c('Month', 'Year', 'Store'))]

summary(data_sub)
```

## A. Aggregate Time Series Analysis
How is the Walmart aggregate sales looks like? Does this sales has seasonal component?
## Below is the Aggregate Sales for the whole Walmart Store


```{r}

holiday_date <- as.Date(c('2010-02-12', '2010-09-10',
                          '2010-11-26', '2010-12-31',
                          '2011-02-11', '2011-09-09',
                          '2011-11-25', '2011-12-30',
                          '2012-02-10', '2012-09-07'))

locate <- as.Date('2011-05-06')

agg_sales <- aggregate(panel$Weekly_Sales, by = list(Date = panel$Date), FUN = sum)

ggplot(agg_sales, aes(x = Date, y = x)) +
  geom_line(color = "steelblue", size = 1) +
  geom_line(data = transform(agg_sales, x = rollmean(x, k = 12, fill = NA)), 
            aes(x = Date, y = x), color = "firebrick", size = 1) +
  geom_vline(xintercept = as.numeric(holiday_date), color = "darkred", alpha = 0.2, linetype = "dashed") +
  labs(title = "Walmart Aggregate Sales Trend\n(In Thousand Dollars)",
       x = NULL, y = NULL) +
  theme_bw() +
  theme(plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
        axis.text.x = element_text(angle = 45, vjust = 0.5, hjust = 1),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_rect(fill = "white"),
        plot.margin = margin(20, 20, 20, 20, "pt"))




```

The graph tell us that this data contain seasonal component on holiday date (red line). Walmart sales seems rapidly increased when holiday date taking place. But in the other side (non-holiday date), sales tend to be in stagnant position. It means we have to be careful interpreting sales volume (Growth sales would be good metrics). Before that, next we'll discuss more little depth which holiday contribute more in Walmart sales aggregately.


## Below are the detail about sales in holiday, are thanksgiving holiday have highest sales?


```{r}

super_bowl <- c('2010-02-12', '2011-02-11', '2012-02-10')
labour_day <- c('2010-09-10', '2011-09-09', '2012-09-07')
thanksgiving <- c('2010-11-26', '2011-11-25', '2012-11-23')
christmas <- c('2010-12-31', '2011-12-30', '2012-12-28')

super_bowl_sales <- sum(data$Weekly_Sales[data$Date == '2011-02-11'])
labour_day_sales <- sum(data$Weekly_Sales[data$Date == '2011-09-09'])
thanksgiving_sales <- sum(data$Weekly_Sales[data$Date == '2011-11-25'])
christmas_sales <- sum(data$Weekly_Sales[data$Date == '2011-12-30'])

holiday_sales <- data.frame(
  Holiday = c("Super Bowl", "Labour Day", "Thanksgiving", "Christmas"),
  Sales = c(super_bowl_sales, labour_day_sales, thanksgiving_sales, christmas_sales)
)

holiday_sales$Sales <- round(holiday_sales$Sales, 2)

ggplot(holiday_sales, aes(x = Holiday, y = Sales, fill = Holiday)) +
  geom_bar(stat = "identity", width = 0.5, color = "black") +
  geom_text(aes(label = paste0(Sales, "k")), vjust = -0.5, size = 8, fontface = "bold", color = "white") +
  labs(title = "Are Thanksgiving Holidays the Highest Sales Contributors?",
       x = NULL, y = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 0.5, size = 12, color = "black"),
        axis.text.y = element_text(size = 12, color = "black"),
        axis.title = element_text(size = 14, color = "black", face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 18, color = "black", face = "bold", hjust = 0.5),
        plot.caption = element_text(size = 10, color = "gray50", hjust = 1),
        plot.background = element_rect(fill = "white"),
        panel.border = element_rect(color = "black", fill = NA),
        axis.line = element_line(color = "black"),
        plot.margin = margin(50, 50, 30, 30)) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.1))) +
  coord_cartesian(ylim = c(0, max(holiday_sales$Sales) * 1.2)) +
  annotate("text", x = holiday_sales$Holiday, y = holiday_sales$Sales,
           label = paste0(holiday_sales$Sales, "k"), vjust = -0.5, size = 6, fontface = "bold", color = "white") +
  geom_hline(yintercept = mean(holiday_sales$Sales), linetype = "dashed", color = "gray40", size = 1) +
  geom_point(aes(x = holiday_sales$Holiday, y = holiday_sales$Sales),
             shape = 21, fill = "white", color = "black", size = 4) +
  guides(fill = "none")




```

```{r}

pivot_table <- panel %>%
  group_by(Date) %>%
  summarize(Weekly_Sales = sum(Weekly_Sales),
            Temperature = mean(Temperature),
            Fuel_Price = mean(Fuel_Price),
            CPI = mean(CPI),
            Unemployment = mean(Unemployment)) %>%
  tidyr::separate(Date, into = c("Year", "Month", "Day"), sep = "-") %>%
  select(-Day)

head(pivot_table)


```


```{r}

pairplot <- pivot_table[, !(names(pivot_table) %in% c("Month", "Year"))]
pairs(pairplot)


```

```{r}
cor_matrix <- cor(pivot_table[, !(names(pivot_table) %in% c("Month", "Year"))])
cor_matrix



```
It seems that sales have less correlation with macroeconomic condition. Possible reason of this realtionship that because we use weekly data and macroeconomic variables like CPI, unemployment, fuel price have slow/rigid change in the short run.


```{r}


growth_df <- panel %>%
  select(Date, Weekly_Sales) %>%
  group_by(Date = as.yearmon(Date)) %>%
  summarize(Weekly_Sales = sum(Weekly_Sales)) %>%
  ungroup() %>%
  mutate(Rolling_Month = lag(Weekly_Sales),
         Growth_MoM = round((Weekly_Sales - Rolling_Month) / Rolling_Month * 100, 2))

growth_df <- growth_df %>%
  mutate(growth_df = lead(growth_df)) %>%
  select(-c(3, 4))

growth_df$Year <- year(growth_df$Date)
growth_df$Month <- month(growth_df$Date)

super_bowl <- c('2010-02-28', '2011-02-28', '2012-02-28')
labour_day <- c('2010-09-30', '2011-09-30', '2012-09-30')
thanksgiving <- c('2010-11-30', '2011-11-30', '2012-11-30')
christmas <- c('2010-12-31', '2011-12-31', '2012-12-31')

g2010 <- growth_df %>%
  filter(Year == 2010) %>%
  summarize(Month = Month[which.max(growth_df$Growth_MoM)], Growth_MoM = max(growth_df$Growth_MoM))

g2011 <- growth_df %>%
  filter(Year == 2011) %>%
  summarize(Month = Month[which.max(growth_df$Growth_MoM)], Growth_MoM = max(growth_df$Growth_MoM))

g2012 <- growth_df %>%
  filter(Year == 2012) %>%
  summarize(Month = Month[which.max(growth_df$Growth_MoM)], Growth_MoM = max(growth_df$Growth_MoM))





# Create a data frame with the text labels
text_labels <- data.frame(
  x = c(0.7, 0.2, 0.2, 0.75, 0.75, 0.75, 1.3, 1.3, 1.3),
  y = c(0.85, 0.5, 0.3, 0.5, 0.3, 0.1, 0.5, 0.3, 0.1),
  label = c("Highest Sales MoM Growth", "December", "42.35%", "December", "37.07%", "2011", "October", "27.46%", "2012"),
  #color = c("black", "blue", "gray", "blue", "gray", "gray", "blue", "gray", "gray"),
  #size = c(6, 12, 8, 12, 8, 8, 12, 8, 8),
  fontface = c("bold", "bold", "bold", "bold", "bold", "bold", "bold", "bold", "bold"),
  family = c("sans", "mono", "mono", "mono", "mono", "mono", "mono", "mono", "mono"),
  vjust = c(0, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5),
  hjust = c(0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5)
)

# Create the plot
fig <- ggplot() +
  theme_void() +
  theme(plot.margin = margin(0, 0, 0, 0, "cm"))

# Add text elements to the plot
fig <- fig +
  geom_text(data = text_labels, aes(x = x, y = y, label = label,  
                                    fontface = fontface, family = family, vjust = vjust, hjust = hjust))

# Show the plot
print(fig)




```

Although Thanksgiving holiday on November has highest sales than the other holiday, December has the highest growth sales happening before Christmas in 2010 and 2011. It stated that in 2012, October become the highest MoM sales growth because we don't have sales data on December 2012.

# Sales Panel Analysis by Store
```{r}
sales_store <- panel %>%
  group_by(Store) %>%
  summarize(Weekly_Sales = sum(Weekly_Sales))

sales_store <- sales_store %>%
  arrange(Weekly_Sales) %>%
  mutate(Store = factor(Store, levels = unique(Store)))

ggplot(sales_store, aes(x = Store, y = Weekly_Sales, fill = Store)) +
  geom_bar(stat = "identity", width = 1, color = "black") +
  labs(title = "Walmart Aggregate Sales by Store (In Thousand Dollars)",
       x = "Store", y = NULL, caption = "") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, vjust = 0.5, size = 5, color = "black"),
        axis.text.y = element_text(size = 5, color = "black"),
        axis.title = element_text(size = 12, color = "black", face = "bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 12, color = "black", face = "bold", hjust = 0.5),
        plot.caption = element_text(size = 12, color = "gray50", hjust = 1),
        plot.background = element_rect(fill = "white"),
        panel.border = element_rect(color = "black", fill = NA),
        axis.line = element_line(color = "black"),
        plot.margin = margin(25, 25, 25, 25)) +
  scale_y_continuous(labels = comma, expand = expansion(mult = c(0, 0.1))) +
  geom_text(x = 7, y = 320000, label = "Walmart Aggregate Sales by Store\n(In Thousand Dollars)",
            size = 2, family = "serif", color = "black", hjust = 0.5) +
  geom_text(x = 2.5, y = 230000, label = "Walmart Store that has higher sales in the period is Store 20 followed by Store 4 and 14.\nThe insight stops here because we don't know exactly where the store location is.\nBut we will define how the trend is behind it.",
            size = 2, family = "serif", color = "black", hjust = 0)

```



```{r}

```


